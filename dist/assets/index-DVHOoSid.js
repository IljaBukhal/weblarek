(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const v of c.addedNodes)v.tagName==="LINK"&&v.rel==="modulepreload"&&i(v)}).observe(document,{childList:!0,subtree:!0});function s(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function i(o){if(o.ep)return;o.ep=!0;const c=s(o);fetch(o.href,c)}})();function _(e){return typeof e=="string"&&e.length>1}function L(e,t=document){if(_(e))return Array.from(t.querySelectorAll(e));if(e instanceof NodeList)return Array.from(e);if(Array.isArray(e))return e;throw new Error("Unknown selector element")}function n(e,t){if(_(e)){const s=L(e,t);if(s.length>1&&console.warn(`selector ${e} return more then one element`),s.length===0)throw new Error(`selector ${e} return nothing`);return s.pop()}if(e instanceof HTMLElement)return e;throw new Error("Unknown selector element")}function u(e){const t=n(e);if(!t.content.firstElementChild)throw new Error(`Template ${e} has no content`);return t.content.firstElementChild.cloneNode(!0)}class h{constructor(t){this.container=t}setImage(t,s,i){t&&(t.src=s,i&&(t.alt=i))}render(t){return Object.assign(this,t??{}),this.container}}class E extends h{constructor(t,s){super(t),this.events=s,this.cardElem=this.container,this.titleElem=n(".card__title",this.cardElem),this.priceElem=n(".card__price",this.cardElem)}cardElem;titleElem;priceElem;set id(t){this.cardElem.setAttribute("id",t)}set title(t){this.titleElem.textContent=t}set price(t){this.priceElem.textContent=t===null?"Бесценно":`${t} синапсов`}}class w extends E{indexElem;deleteBtn;constructor(t,s){super(t,s),this.indexElem=n(".basket__item-index",this.container),this.deleteBtn=n(".card__button",this.container),this.deleteBtn.addEventListener("click",i=>{this.events.emit("basked-delete-card-btn:pressing",i)})}set index(t){this.indexElem.textContent=String(t)}}const S="https://larek-api.nomoreparties.co/api/weblarek",y="https://larek-api.nomoreparties.co/content/weblarek",B={"софт-скил":"card__category_soft","хард-скил":"card__category_hard",кнопка:"card__category_button",дополнительное:"card__category_additional",другое:"card__category_other"};class x extends E{categoryElem;imageElem;constructor(t,s){super(t,s),this.container.addEventListener("click",()=>{this.events.emit("gallery-card:select",{cardElement:this.container})}),this.categoryElem=n(".card__category",this.cardElem),this.imageElem=n(".card__image",this.cardElem)}set category(t){this.categoryElem.textContent=t,this.categoryElem.classList.remove("card__category_soft"),this.categoryElem.classList.add(`${B[t]}`)}set image(t){this.imageElem.setAttribute("src",`${y}${t}`),this.imageElem.setAttribute("alt",this.titleElem.textContent??"")}}class M extends E{imageElem;categoryElem;descriptionElem;buttonElem;constructor(t,s){super(t,s),this.imageElem=n(".card__image",this.container),this.categoryElem=n(".card__category",this.container),this.descriptionElem=n(".card__text",this.container),this.buttonElem=n(".card__button",this.container),this.buttonElem.addEventListener("click",()=>{this.events.emit("preview-card-btn:pressing")})}set category(t){this.categoryElem.textContent=t,this.categoryElem.classList.remove("card__category_other"),this.categoryElem.classList.add(`${B[t]}`)}set image(t){this.imageElem.setAttribute("src",`${y}${t}`),this.imageElem.setAttribute("alt",this.titleElem.textContent??"")}set description(t){this.descriptionElem.textContent=t}setButtonSate(t){switch(t){case"buy":this.buttonElem.textContent="Купить",this.buttonElem.removeAttribute("disabled");break;case"unavailable":this.buttonElem.textContent="Недоступно",this.buttonElem.setAttribute("disabled","true");break;case"delete":this.buttonElem.textContent="Удалить из корзины",this.buttonElem.removeAttribute("disabled")}}}class $ extends h{constructor(t){super(t),this.container=t}set catalog(t){this.container.append(...t)}}class T extends h{constructor(t,s){super(t),this.events=s,this.container.addEventListener("click",i=>{i.target.classList.contains("modal")&&this.events.emit("modal:close")}),this.closeButton=n(".modal__close",this.container),this.closeButton.addEventListener("click",()=>{this.events.emit("modal:close")}),this.contentContainer=n(".modal__content",this.container)}closeButton;contentContainer;set display(t){t?this.container.classList.add("modal_active"):this.container.classList.remove("modal_active")}set content(t){this.contentContainer.replaceChildren(t)}}class I extends h{constructor(t,s){super(t),this.events=s,this.basketList=n(".basket__list",this.container),this.basketButton=n(".basket__button",this.container),this.basketButton.addEventListener("click",()=>{this.events.emit("checkout-button:pressed")}),this.basketPrice=n(".basket__price",this.container)}basketList;basketButton;basketPrice;set selectedProducts(t){this.basketList.replaceChildren(...t)}set price(t){this.basketPrice.textContent=`${t} синапсов`}setButtonSate(t){t==="inactive"?this.basketButton.setAttribute("disabled","true"):this.basketButton.removeAttribute("disabled")}}class O extends h{constructor(t,s){super(t),this.events=s,this.descriptionElem=n(".order-success__description",this.container),this.buttonElem=n(".order-success__close",this.container),this.buttonElem.addEventListener("click",()=>{this.events.emit("modal:close")})}descriptionElem;buttonElem;set synapses(t){this.descriptionElem.textContent=`Списано ${t} синапсов`}}class F extends h{constructor(t,s){super(t),this.events=s,this.basketButton=n(".header__basket",this.container),this.counterElement=n(".header__basket-counter",this.container),this.basketButton.addEventListener("click",()=>{this.events.emit("open-basket-button:pressing")})}basketButton;counterElement;set counter(t){this.counterElement.textContent=String(t)}}class k extends h{constructor(t,s){super(t),this.events=s,this.modalActionsElem=n(".modal__actions",this.container),this.submitButton=n(".button",this.modalActionsElem),this.formErrElem=n(".form__errors",this.modalActionsElem)}modalActionsElem;submitButton;formErrElem;set errorMessage(t){this.formErrElem.textContent=t}setSubmitButtonSate(t){t==="inactive"?this.submitButton.setAttribute("disabled","true"):this.submitButton.removeAttribute("disabled")}}class R extends k{cardButton;cashButton;inputAddress;constructor(t,s){super(t,s),this.cardButton=n('button[name="card"]',this.container),this.cardButton.addEventListener("click",()=>{this.events.emit("card-button:select"),this.events.emit("order-form:validation",{cardButton:this.cardButton,cashButton:this.cashButton,inputAddress:this.inputAddress})}),this.cashButton=n('button[name="cash"]',this.container),this.cashButton.addEventListener("click",()=>{this.events.emit("cash-button:select"),this.events.emit("order-form:validation",{cardButton:this.cardButton,cashButton:this.cashButton,inputAddress:this.inputAddress})}),this.inputAddress=n('input[name="address"]',this.container),this.inputAddress.addEventListener("input",()=>{this.events.emit("order-form:validation",{cardButton:this.cardButton,cashButton:this.cashButton,inputAddress:this.inputAddress})}),this.container.addEventListener("submit",i=>{this.events.emit("order-form-submit-btn:pressing",{submitEvent:i,cardButton:this.cardButton,inputAddress:this.inputAddress})})}set paymentMethod(t){this.cardButton.classList.remove("button_alt-active"),this.cashButton.classList.remove("button_alt-active"),t==="card"&&this.cardButton.classList.add("button_alt-active"),t==="cash"&&this.cashButton.classList.add("button_alt-active")}set address(t){this.inputAddress.value=t}}class U extends k{inputEmail;inputPhone;constructor(t,s){super(t,s),this.container.addEventListener("submit",i=>{this.events.emit("contacts-form-submit-btn:pressing",{submitEvent:i,inputEmail:this.inputEmail,inputPhone:this.inputPhone})}),this.inputEmail=n('input[name="email"]',this.container),this.inputEmail.addEventListener("input",()=>{this.events.emit("contacts-form:validation",{inputEmail:this.inputEmail,inputPhone:this.inputPhone})}),this.inputPhone=n('input[name="phone"]',this.container),this.inputPhone.addEventListener("input",()=>{this.events.emit("contacts-form:validation",{inputEmail:this.inputEmail,inputPhone:this.inputPhone})})}set email(t){this.inputEmail.value=t}set phone(t){this.inputPhone.value=t}}class D{baseUrl;options;constructor(t,s={}){this.baseUrl=t,this.options={headers:{"Content-Type":"application/json",...s.headers??{}}}}handleResponse(t){return t.ok?t.json():t.json().then(s=>Promise.reject(s.error??t.statusText))}get(t){return fetch(this.baseUrl+t,{...this.options,method:"GET"}).then(this.handleResponse)}post(t,s,i="POST"){return fetch(this.baseUrl+t,{...this.options,method:i,body:JSON.stringify(s)}).then(this.handleResponse)}}class j{api;constructor(t){this.api=t}getProducts(){return this.api.get("/product/")}postOrder(t){return this.api.post("/order/",t,"POST")}}class N{_events;constructor(){this._events=new Map}on(t,s){this._events.has(t)||this._events.set(t,new Set),this._events.get(t)?.add(s)}off(t,s){this._events.has(t)&&(this._events.get(t).delete(s),this._events.get(t)?.size===0&&this._events.delete(t))}emit(t,s){this._events.forEach((i,o)=>{o==="*"&&i.forEach(c=>c({eventName:t,data:s})),(o instanceof RegExp&&o.test(t)||o===t)&&i.forEach(c=>c(s))})}onAll(t){this.on("*",t)}offAll(){this._events=new Map}trigger(t,s){return(i={})=>{this.emit(t,{...i||{},...s||{}})}}}class G{constructor(t){this.events=t}_selectedProducts=[];getSelectedProducts(){return this._selectedProducts}addProductToBasket(t){this._selectedProducts.push(t),this.events.emit("basket-contents:changing")}removeProductFromBasket(t){this._selectedProducts=this._selectedProducts.filter(s=>s.id!==t),this.events.emit("basket-contents:changing")}clearBasket(){this._selectedProducts=[],this.events.emit("basket-contents:changing")}getTotalPrice(){return this._selectedProducts.reduce((t,s)=>t+(s.price??0),0)}getNumberProductsInBasket(){return this._selectedProducts.length}isProductInBasket(t){return this._selectedProducts.some(s=>s.id===t)}}class H{constructor(t){this.events=t}products=[];selectedCard;saveProducts(t){this.products=t,this.events.emit("catalog:changing")}getProducts(){return this.products}getProductById(t){return this.products.find(s=>s.id===t)}selectProduct(t){this.selectedCard=t,this.events.emit("selected-product:changing")}getSelectedCard(){return this.selectedCard}}class q{constructor(t,s){this.events=t,s&&(this.payment=s.payment,this.email=s.email,this.phone=s.phone,this.address=s.address)}payment="";email="";phone="";address="";changePayment(t){this.payment=t,this.events.emit("buyer-data:changing")}changeEmail(t){this.email=t,this.events.emit("buyer-data:changing")}changePhone(t){this.phone=t,this.events.emit("buyer-data:changing")}changeAddress(t){this.address=t,this.events.emit("buyer-data:changing")}getBuyerData(){return{payment:this.payment,email:this.email,phone:this.phone,address:this.address}}clearBuyerData(){this.payment="",this.email="",this.phone="",this.address="",this.events.emit("buyer-data:changing")}validateData(){const t={};return this.payment||(t.payment="Необходимо выбрать способ оплаты"),this.email||(t.email="Необходимо указать email"),this.phone||(t.phone="Укажите номер телефона"),this.address||(t.address="Укажите свой адрес"),t}}const z=new D(S),P=new j(z),r=new N,p=new H(r),d=new G(r),a=new q(r),J=n(".header"),K=n(".gallery"),Q=n("#modal-container"),C=new F(J,r),V=new $(K),m=new T(Q,r),W=u("#card-preview"),X=u("#basket"),Y=u("#order"),Z=u("#contacts"),tt=u("#success"),b=new M(W,r),f=new I(X,r),l=new R(Y,r),g=new U(Z,r),et=new O(tt,r);C.render({counter:d.getNumberProductsInBasket()});P.getProducts().then(e=>{p.saveProducts(e.items)}).finally(()=>{V.render({catalog:p.getProducts().map(e=>new x(u("#card-catalog"),r).render({id:e.id,image:e.image,title:e.title,category:e.category,price:e.price}))})});document.addEventListener("keydown",e=>{e.key==="Escape"&&r.emit("modal:close")});r.on("modal:close",()=>{m.render({display:!1})});r.on("gallery-card:select",e=>{const t=p.getProductById(e.cardElement.id);p.selectProduct(t)});r.on("selected-product:changing",()=>{const e=p.getSelectedCard();d.isProductInBasket(e?.id)?b.setButtonSate("delete"):e?.price===null?b.setButtonSate("unavailable"):b.setButtonSate("buy"),m.render({display:!0,content:b.render({category:e?.category,description:e?.description,id:e?.id,image:e?.image,price:e?.price,title:e?.title})})});r.on("preview-card-btn:pressing",()=>{const e=p.getSelectedCard();d.isProductInBasket(e.id)?d.removeProductFromBasket(e.id):d.addProductToBasket(e),r.emit("modal:close")});function A(){let e=1;f.setButtonSate(d.getNumberProductsInBasket()?"active":"inactive");const t=d.getSelectedProducts().map(i=>new w(u("#card-basket"),r).render({index:e++,title:i.title,price:i.price,id:i.id}));return f.render({selectedProducts:t,price:d.getTotalPrice()})}r.on("basket-contents:changing",()=>{C.render({counter:d.getNumberProductsInBasket()})});r.on("open-basket-button:pressing",()=>{m.render({display:!0,content:A()})});r.on("basked-delete-card-btn:pressing",e=>{const s=e.currentTarget.closest(".card");d.removeProductFromBasket(s.id),m.render({content:A()})});r.on("checkout-button:pressed",()=>{a.payment!==""&&a.address!==""&&l.setSubmitButtonSate("active"),m.render({content:l.render({paymentMethod:a.payment,address:a.address,errorMessage:""})})});r.on("order-form:validation",e=>{const t=!e.cardButton.classList.contains("button_alt-active")&&!e.cashButton.classList.contains("button_alt-active")?"Необходимо выбрать способ оплаты":null,s=e.inputAddress.value===""?"Укажите свой адрес":null;t===null&&s===null?l.setSubmitButtonSate("active"):l.setSubmitButtonSate("inactive");const i=t!==null&&s!==null?", ":"";l.errorMessage=`${t??""}${i}${s??""}`});r.on("card-button:select",()=>{l.paymentMethod="card"});r.on("cash-button:select",()=>{l.paymentMethod="cash"});r.on("order-form-submit-btn:pressing",e=>{e.submitEvent.preventDefault(),e.cardButton.classList.contains("button_alt-active")?a.changePayment("card"):a.changePayment("cash"),a.changeAddress(e.inputAddress.value),a.email!==""&&a.phone!==""&&g.setSubmitButtonSate("active"),m.render({content:g.render({email:a.email,phone:a.phone,errorMessage:""})})});r.on("contacts-form:validation",e=>{const t=e.inputEmail.value===""?"Укажите свой email":null,s=e.inputPhone.value===""?"Укажите свой номер телефона":null;t===null&&s===null?g.setSubmitButtonSate("active"):g.setSubmitButtonSate("inactive");const i=t!==null&&s!==null?", ":"";g.errorMessage=`${t??""}${i}${s??""}`});r.on("contacts-form-submit-btn:pressing",e=>{e.submitEvent.preventDefault(),a.changeEmail(e.inputEmail.value),a.changePhone(e.inputPhone.value);const t=d.getSelectedProducts().map(s=>s.id);P.postOrder({payment:a.payment,address:a.address,email:a.email,phone:a.phone,items:t,total:d.getTotalPrice()}).then(s=>{m.render({content:et.render({synapses:s.total})})}).then(()=>{d.clearBasket(),a.clearBuyerData()}).catch(s=>alert(s))});
