(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const c of a)if(c.type==="childList")for(const v of c.addedNodes)v.tagName==="LINK"&&v.rel==="modulepreload"&&i(v)}).observe(document,{childList:!0,subtree:!0});function s(a){const c={};return a.integrity&&(c.integrity=a.integrity),a.referrerPolicy&&(c.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?c.credentials="include":a.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function i(a){if(a.ep)return;a.ep=!0;const c=s(a);fetch(a.href,c)}})();function y(e){return typeof e=="string"&&e.length>1}function L(e,t=document){if(y(e))return Array.from(t.querySelectorAll(e));if(e instanceof NodeList)return Array.from(e);if(Array.isArray(e))return e;throw new Error("Unknown selector element")}function n(e,t){if(y(e)){const s=L(e,t);if(s.length>1&&console.warn(`selector ${e} return more then one element`),s.length===0)throw new Error(`selector ${e} return nothing`);return s.pop()}if(e instanceof HTMLElement)return e;throw new Error("Unknown selector element")}function u(e){const t=n(e);if(!t.content.firstElementChild)throw new Error(`Template ${e} has no content`);return t.content.firstElementChild.cloneNode(!0)}class m{constructor(t){this.container=t}setImage(t,s,i){t&&(t.src=s,i&&(t.alt=i))}render(t){return Object.assign(this,t??{}),this.container}}class f extends m{constructor(t,s){super(t),this.events=s,this.cardElem=this.container,this.titleElem=n(".card__title",this.cardElem),this.priceElem=n(".card__price",this.cardElem)}cardElem;titleElem;priceElem;set id(t){this.cardElem.setAttribute("id",t)}set title(t){this.titleElem.textContent=t}set price(t){this.priceElem.textContent=t===null?"Бесценно":`${t} синапсов`}}class S extends f{indexElem;deleteBtn;constructor(t,s){super(t,s),this.indexElem=n(".basket__item-index",this.container),this.deleteBtn=n(".card__button",this.container),this.deleteBtn.addEventListener("click",i=>{this.events.emit("basked-delete-card-btn:pressing",i)})}set index(t){this.indexElem.textContent=String(t)}}const x="https://larek-api.nomoreparties.co/api/weblarek",_="https://larek-api.nomoreparties.co/content/weblarek",k={"софт-скил":"card__category_soft","хард-скил":"card__category_hard",кнопка:"card__category_button",дополнительное:"card__category_additional",другое:"card__category_other"};class A extends f{categoryElem;imageElem;constructor(t,s){super(t,s),this.container.addEventListener("click",()=>{this.events.emit("gallery-card:select",{cardElement:this.container})}),this.categoryElem=n(".card__category",this.cardElem),this.imageElem=n(".card__image",this.cardElem)}set category(t){this.categoryElem.textContent=t,this.categoryElem.classList.remove("card__category_soft"),this.categoryElem.classList.add(`${k[t]}`)}set image(t){this.setImage(this.imageElem,`${_}${t}`,this.titleElem.textContent??void 0)}}class M extends f{imageElem;categoryElem;descriptionElem;buttonElem;constructor(t,s){super(t,s),this.imageElem=n(".card__image",this.container),this.categoryElem=n(".card__category",this.container),this.descriptionElem=n(".card__text",this.container),this.buttonElem=n(".card__button",this.container),this.buttonElem.addEventListener("click",()=>{this.events.emit("preview-card-btn:pressing")})}set category(t){this.categoryElem.textContent=t,this.categoryElem.classList.remove("card__category_other"),this.categoryElem.classList.add(`${k[t]}`)}set image(t){this.setImage(this.imageElem,`${_}${t}`,this.titleElem.textContent??void 0)}set description(t){this.descriptionElem.textContent=t}setButtonSate(t){switch(t){case"buy":this.buttonElem.textContent="Купить",this.buttonElem.removeAttribute("disabled");break;case"unavailable":this.buttonElem.textContent="Недоступно",this.buttonElem.setAttribute("disabled","true");break;case"delete":this.buttonElem.textContent="Удалить из корзины",this.buttonElem.removeAttribute("disabled")}}}class $ extends m{constructor(t){super(t),this.container=t}set catalog(t){this.container.append(...t)}}class T extends m{constructor(t,s){super(t),this.events=s,this.container.addEventListener("click",i=>{i.target.classList.contains("modal")&&this.events.emit("modal:close")}),this.closeButton=n(".modal__close",this.container),this.closeButton.addEventListener("click",()=>{this.events.emit("modal:close")}),this.contentContainer=n(".modal__content",this.container)}closeButton;contentContainer;set display(t){t?(this.container.classList.add("modal_active"),document.addEventListener("keydown",this.escapeHandler)):(this.container.classList.remove("modal_active"),document.removeEventListener("keydown",this.escapeHandler))}set content(t){this.contentContainer.replaceChildren(t)}escapeHandler=t=>{t.key==="Escape"&&this.events.emit("modal:close")}}class I extends m{constructor(t,s){super(t),this.events=s,this.basketList=n(".basket__list",this.container),this.basketButton=n(".basket__button",this.container),this.basketButton.addEventListener("click",()=>{this.events.emit("checkout-button:pressed")}),this.basketPrice=n(".basket__price",this.container)}basketList;basketButton;basketPrice;set selectedProducts(t){this.basketList.replaceChildren(...t)}set price(t){this.basketPrice.textContent=`${t} синапсов`}setButtonSate(t){t==="inactive"?this.basketButton.setAttribute("disabled","true"):this.basketButton.removeAttribute("disabled")}}class O extends m{constructor(t,s){super(t),this.events=s,this.descriptionElem=n(".order-success__description",this.container),this.buttonElem=n(".order-success__close",this.container),this.buttonElem.addEventListener("click",()=>{this.events.emit("modal:close")})}descriptionElem;buttonElem;set synapses(t){this.descriptionElem.textContent=`Списано ${t} синапсов`}}class D extends m{constructor(t,s){super(t),this.events=s,this.basketButton=n(".header__basket",this.container),this.counterElement=n(".header__basket-counter",this.container),this.basketButton.addEventListener("click",()=>{this.events.emit("open-basket-button:pressing")})}basketButton;counterElement;set counter(t){this.counterElement.textContent=String(t)}}class B extends m{constructor(t,s){super(t),this.events=s,this.modalActionsElem=n(".modal__actions",this.container),this.submitButton=n(".button",this.modalActionsElem),this.formErrElem=n(".form__errors",this.modalActionsElem)}modalActionsElem;submitButton;formErrElem;set errorMessage(t){this.formErrElem.textContent=t}setSubmitButtonSate(t){t==="inactive"?this.submitButton.setAttribute("disabled","true"):this.submitButton.removeAttribute("disabled")}}class F extends B{cardButton;cashButton;inputAddress;constructor(t,s){super(t,s),this.cardButton=n('button[name="card"]',this.container),this.cardButton.addEventListener("click",()=>{this.events.emit("card-button:select"),this.events.emit("order-form:validation",{paymentMethod:this.getPaymentMethod(),address:this.inputAddress.value})}),this.cashButton=n('button[name="cash"]',this.container),this.cashButton.addEventListener("click",()=>{this.events.emit("cash-button:select"),this.events.emit("order-form:validation",{paymentMethod:this.getPaymentMethod(),address:this.inputAddress.value})}),this.inputAddress=n('input[name="address"]',this.container),this.inputAddress.addEventListener("input",()=>{this.events.emit("order-form:validation",{paymentMethod:this.getPaymentMethod(),address:this.inputAddress.value})}),this.container.addEventListener("submit",i=>{i.preventDefault(),this.events.emit("order-form-submit-btn:pressing")})}set paymentMethod(t){this.cardButton.classList.remove("button_alt-active"),this.cashButton.classList.remove("button_alt-active"),t==="card"&&this.cardButton.classList.add("button_alt-active"),t==="cash"&&this.cashButton.classList.add("button_alt-active")}set address(t){this.inputAddress.value=t}getPaymentMethod(){return this.cardButton.classList.contains("button_alt-active")?"card":this.cashButton.classList.contains("button_alt-active")?"cash":""}}class R extends B{inputEmail;inputPhone;constructor(t,s){super(t,s),this.container.addEventListener("submit",i=>{i.preventDefault(),this.events.emit("contacts-form-submit-btn:pressing")}),this.inputEmail=n('input[name="email"]',this.container),this.inputEmail.addEventListener("input",()=>{this.events.emit("contacts-form:validation",{email:this.inputEmail.value,phone:this.inputPhone.value})}),this.inputPhone=n('input[name="phone"]',this.container),this.inputPhone.addEventListener("input",()=>{this.events.emit("contacts-form:validation",{email:this.inputEmail.value,phone:this.inputPhone.value})})}set email(t){this.inputEmail.value=t}set phone(t){this.inputPhone.value=t}}class U{baseUrl;options;constructor(t,s={}){this.baseUrl=t,this.options={headers:{"Content-Type":"application/json",...s.headers??{}}}}handleResponse(t){return t.ok?t.json():t.json().then(s=>Promise.reject(s.error??t.statusText))}get(t){return fetch(this.baseUrl+t,{...this.options,method:"GET"}).then(this.handleResponse)}post(t,s,i="POST"){return fetch(this.baseUrl+t,{...this.options,method:i,body:JSON.stringify(s)}).then(this.handleResponse)}}class j{api;constructor(t){this.api=t}getProducts(){return this.api.get("/product/")}postOrder(t){return this.api.post("/order/",t,"POST")}}class H{_events;constructor(){this._events=new Map}on(t,s){this._events.has(t)||this._events.set(t,new Set),this._events.get(t)?.add(s)}off(t,s){this._events.has(t)&&(this._events.get(t).delete(s),this._events.get(t)?.size===0&&this._events.delete(t))}emit(t,s){this._events.forEach((i,a)=>{a==="*"&&i.forEach(c=>c({eventName:t,data:s})),(a instanceof RegExp&&a.test(t)||a===t)&&i.forEach(c=>c(s))})}onAll(t){this.on("*",t)}offAll(){this._events=new Map}trigger(t,s){return(i={})=>{this.emit(t,{...i||{},...s||{}})}}}class N{constructor(t){this.events=t}_selectedProducts=[];getSelectedProducts(){return this._selectedProducts}addProductToBasket(t){this._selectedProducts.push(t),this.events.emit("basket-contents:changing")}removeProductFromBasket(t){this._selectedProducts=this._selectedProducts.filter(s=>s.id!==t),this.events.emit("basket-contents:changing")}clearBasket(){this._selectedProducts=[],this.events.emit("basket-contents:changing")}getTotalPrice(){return this._selectedProducts.reduce((t,s)=>t+(s.price??0),0)}getNumberProductsInBasket(){return this._selectedProducts.length}isProductInBasket(t){return this._selectedProducts.some(s=>s.id===t)}}class G{constructor(t){this.events=t}products=[];selectedCard;saveProducts(t){this.products=t,this.events.emit("catalog:changing")}getProducts(){return this.products}getProductById(t){return this.products.find(s=>s.id===t)}selectProduct(t){this.selectedCard=t,this.events.emit("selected-product:changing")}getSelectedCard(){return this.selectedCard}}class q{constructor(t,s){this.events=t,s&&(this.payment=s.payment,this.email=s.email,this.phone=s.phone,this.address=s.address)}payment="";email="";phone="";address="";changePayment(t){this.payment=t,this.events.emit("buyer-data:changing")}changeEmail(t){this.email=t,this.events.emit("buyer-data:changing")}changePhone(t){this.phone=t,this.events.emit("buyer-data:changing")}changeAddress(t){this.address=t,this.events.emit("buyer-data:changing")}getBuyerData(){return{payment:this.payment,email:this.email,phone:this.phone,address:this.address}}clearBuyerData(){this.payment="",this.email="",this.phone="",this.address="",this.events.emit("buyer-data:changing")}validateData(){const t={};return this.payment||(t.payment="Необходимо выбрать способ оплаты"),this.email||(t.email="Необходимо указать email"),this.phone||(t.phone="Укажите номер телефона"),this.address||(t.address="Укажите свой адрес"),t}}const z=new U(x),P=new j(z),r=new H,p=new G(r),d=new N(r),o=new q(r),J=n(".header"),K=n(".gallery"),Q=n("#modal-container"),C=new D(J,r),V=new $(K),l=new T(Q,r),W=u("#card-preview"),X=u("#basket"),Y=u("#order"),Z=u("#contacts"),tt=u("#success"),b=new M(W,r),E=new I(X,r),h=new F(Y,r),g=new R(Z,r),et=new O(tt,r);function st(){l.render({display:!1})}function w(){let e=1;E.setButtonSate(d.getNumberProductsInBasket()?"active":"inactive");const t=d.getSelectedProducts().map(i=>new S(u("#card-basket"),r).render({index:e++,title:i.title,price:i.price,id:i.id}));return E.render({selectedProducts:t,price:d.getTotalPrice()})}C.render({counter:d.getNumberProductsInBasket()});P.getProducts().then(e=>{p.saveProducts(e.items)}).finally(()=>{V.render({catalog:p.getProducts().map(e=>new A(u("#card-catalog"),r).render({id:e.id,image:e.image,title:e.title,category:e.category,price:e.price}))})});r.on("modal:close",()=>{l.render({display:!1})});r.on("gallery-card:select",e=>{const t=p.getProductById(e.cardElement.id);p.selectProduct(t)});r.on("selected-product:changing",()=>{const e=p.getSelectedCard();d.isProductInBasket(e?.id)?b.setButtonSate("delete"):e?.price===null?b.setButtonSate("unavailable"):b.setButtonSate("buy"),l.render({display:!0,content:b.render({category:e?.category,description:e?.description,id:e?.id,image:e?.image,price:e?.price,title:e?.title})})});r.on("preview-card-btn:pressing",()=>{const e=p.getSelectedCard();d.isProductInBasket(e.id)?d.removeProductFromBasket(e.id):d.addProductToBasket(e),st()});r.on("basket-contents:changing",()=>{C.render({counter:d.getNumberProductsInBasket()})});r.on("open-basket-button:pressing",()=>{l.render({display:!0,content:w()})});r.on("basked-delete-card-btn:pressing",e=>{const s=e.currentTarget.closest(".card");d.removeProductFromBasket(s.id),l.render({content:w()})});r.on("checkout-button:pressed",()=>{o.payment!==""&&o.address!==""&&h.setSubmitButtonSate("active"),l.render({content:h.render({paymentMethod:o.payment,address:o.address})})});r.on("order-form:validation",e=>{o.changePayment(e.paymentMethod),o.changeAddress(e.address);const t=o.validateData().payment??"",s=o.validateData().address??"";t===""&&s===""?h.setSubmitButtonSate("active"):h.setSubmitButtonSate("inactive");const i=t!==""&&s!==""?", ":"";h.errorMessage=`${t}${i}${s}`});r.on("card-button:select",()=>{h.paymentMethod="card"});r.on("cash-button:select",()=>{h.paymentMethod="cash"});r.on("order-form-submit-btn:pressing",()=>{o.email!==""&&o.phone!==""&&g.setSubmitButtonSate("active"),l.render({content:g.render({email:o.email,phone:o.phone})})});r.on("contacts-form:validation",e=>{o.changeEmail(e.email),o.changePhone(e.phone);const t=o.validateData().email??"",s=o.validateData().phone??"";t===""&&s===""?g.setSubmitButtonSate("active"):g.setSubmitButtonSate("inactive");const i=t!==""&&s!==""?", ":"";g.errorMessage=`${t}${i}${s}`});r.on("contacts-form-submit-btn:pressing",()=>{const e=d.getSelectedProducts().map(t=>t.id);P.postOrder({payment:o.payment,address:o.address,email:o.email,phone:o.phone,items:e,total:d.getTotalPrice()}).then(t=>{l.render({content:et.render({synapses:t.total})})}).then(()=>{d.clearBasket(),o.clearBuyerData()}).catch(t=>alert(t))});
